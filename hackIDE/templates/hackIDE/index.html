{% extends 'hackIDE/base.html' %}
{% load static %}

{% block title %}CODEBUZZ| Online Code Editor, Compiler & Interpreter{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" type="text/css" href="{% static 'hackIDE/css/custom.css' %}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.css">
    <style>
        .editor-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .editor-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px 10px 0 0;
        }

        .editor-main {
            padding: 1.5rem;
        }

        #editor {
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .controls {
            margin-top: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .output-container {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 0 0 10px 10px;
            margin-top: 1rem;
        }

        .output-response-box {
            margin-top: 20px;
            display: none;
        }

        .output-details {
            text-align: center;
            padding: 10px;
            border: 1px solid #aaa;
            background-color: rgb(245, 245, 245);
        }

        .output-details-info {
            display: inline-block;
            margin-right: 6%;
        }

        .output-details-info .key {
            display: inline-block;
            margin-right: 5px;
            font-weight: 700;
        }

        .output-details-info .value {
            display: inline-block;
        }

        .output-io {
            padding: 15px 30px 30px;
            border: 1px solid #aaa;
        }

        .output-io .key, .error-key {
            font-weight: 700;
        }

        .output-io .output-text {
            background: #f2f2f2;
            border: 1px solid #ccc;
            border-radius: 0px;
            padding: 8px;
        }

        .output-io .output-i {
            max-height: 400px;
            overflow-y: scroll;
        }

        .output-io .output-o {
            max-height: 400px;
            overflow-y: scroll;
        }

        .output-io .output-i-info {
        }

        .output-io .output-o-info {
        }

        .output-empty-message {
            color: #888;
            font-size: 16px;
            display: none;
        }

        .output-error-box .error-message {
            background: #ff7272;
            border: 1px solid #faa;
            border-radius: 0px;
            padding: 10px;
        }

        .output-io-info, .output-error-box {
            margin-bottom: 3%;
        }

        .custom-input-container {
            display: none;
            margin-top: 1rem;
        }

        .nice-textarea {
            border: 1px solid #aaa;
            width: 100%;
            height: 100px;
        }
    </style>
{% endblock %}

{% block content %}
    <!-- Hidden input field containing CSRF token required for making AJAX calls to Django -->
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}" />
    <input type="hidden" id='saved_code_content' value="{{ code_content }}" />
    <input type="hidden" id='saved_code_lang' value="{{ lang }}" />
    <input type="hidden" id='saved_code_input' value="{{ inp }}" />
    <input type='hidden' id='compile_status' value={{compile_status}} />
    <input type='hidden' id='run_status_status' value={{run_status_status}} />
    <input type='hidden' id='run_status_time' value={{run_status_time}} />
    <input type='hidden' id='run_status_memory' value={{run_status_memory}} />
    <input type='hidden' id='run_status_output' value={{run_status_output}} />
    <input type='hidden' id='run_status_stderr' value={{run_status_stderr}} />
    <textarea id='copy_link' readonly></textarea>
    
    {% if user.is_authenticated %}
        <div class="container mt-3">
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <strong>Welcome back, {{ user.username }}!</strong> Ready to code? Check out the latest contests or start coding in the editor below.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        </div>
    {% endif %}
    
    <div class="container">
        <div class="editor-container">
            <div class="editor-header">
                <h2>💻 Code Editor</h2>
                <p class="mb-0">Write, compile, and run your code in multiple programming languages</p>
            </div>
            
            <div class="editor-main">
                <div id="editor"># Welcome to hackIDE!
# Write your code here and click 'Run Code' to execute it

print("Hello, World!")
</div>
                
                <div class="controls">
                    <div class="language-selector">
                        <label for="language">Language:</label>
                        <select id="language" class="form-select form-select-sm" style="width: auto; display: inline-block; margin-left: 10px;">
                            <option value="PYTHON" selected>Python</option>
                            <option value="JAVA">Java</option>
                            <option value="CPP">C++</option>
                            <option value="JAVASCRIPT">JavaScript</option>
                            <option value="C">C</option>
                            <option value="CSHARP">C#</option>
                            <option value="PHP">PHP</option>
                            <option value="RUBY">Ruby</option>
                        </select>
                    </div>
                    
                    <div class="action-buttons">
                        <button id="compile-code" class="btn btn-outline-primary">🔨 Compile Code</button>
                        <button id="run-code" class="btn btn-success">🚀 Run Code</button>
                    </div>
                </div>
                
                <div class="custom-input-container">
                    <label for="custom-input">Custom Input (optional):</label>
                    <textarea id="custom-input" class="nice-textarea" placeholder="Enter custom input here..."></textarea>
                </div>
                
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="custom-input-checkbox">
                    <label class="form-check-label" for="custom-input-checkbox">
                        Use custom input
                    </label>
                </div>
            </div>
            
            <div class="output-container">
                <h5>Output</h5>
                <div class="output-response-box">
                    <div class="output-details">
                        <div class="output-details-info run-status">
                            <div class="key">Run Status:</div>
                            <div class="value"></div>
                        </div>
                        <div class="output-details-info compile-status">
                            <div class="key">Compile Status:</div>
                            <div class="value"></div>
                        </div>
                        <div class="output-details-info time-sec">
                            <div class="key">Time (sec):</div>
                            <div class="value"></div>
                        </div>
                        <div class="output-details-info memory-kb">
                            <div class="key">Memory (KB):</div>
                            <div class="value"></div>
                        </div>
                    </div>
                    <div class="output-io">
                        <div class="output-error-box">
                            <div class="error-key"></div>
                            <pre class="error-message"></pre>
                        </div>
                        <div class="output-io-info output-i-info">
                            <div class="key">Input (stdin)</div>
                            <pre class="output-text output-i"> </pre>
                            <span class="output-empty-message output-i-message"><i>Standard input is empty</i></span>
                        </div>
                        <div class="output-io-info output-o-info">
                            <div class="key">Output (stdout)</div>
                            <pre class="output-text output-o"> </pre>
                            <span class="output-empty-message output-o-message"><i>Standard output is empty</i></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <!-- Ace Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    
    <script>
    // Initialize Ace Editor
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/python");
    editor.setOptions({
        enableBasicAutocompletion: true,
        enableLiveAutocompletion: true,
        enableSnippets: true,
        fontSize: 14
    });

    // Boilerplate code for each language
    const boilerplateCode = {
        'PYTHON': `# Welcome to hackIDE!
# Write your code here and click 'Run Code' to execute it

print("Hello, World!")`,
        'JAVA': `// Welcome to hackIDE!
// Write your code here and click 'Run Code' to execute it

public class Main {
    public static void main(String[] args) {
        System.out.println("Hello, World!");
    }
}`,
        'CPP': `// Welcome to hackIDE!
// Write your code here and click 'Run Code' to execute it

#include <iostream>
using namespace std;

int main() {
    cout << "Hello, World!" << endl;
    return 0;
}`,
        'C': `// Welcome to hackIDE!
// Write your code here and click 'Run Code' to execute it

#include <stdio.h>

int main() {
    printf("Hello, World!\\n");
    return 0;
}`,
        'JAVASCRIPT': `// Welcome to hackIDE!
// Write your code here and click 'Run Code' to execute it

console.log("Hello, World!");`,
        'CSHARP': `// Welcome to hackIDE!
// Write your code here and click 'Run Code' to execute it

using System;

class Program {
    static void Main() {
        Console.WriteLine("Hello, World!");
    }
}`,
        'PHP': `<?php
// Welcome to hackIDE!
// Write your code here and click 'Run Code' to execute it

echo "Hello, World!";
?>`,
        'RUBY': `# Welcome to hackIDE!
# Write your code here and click 'Run Code' to execute it

puts "Hello, World!"`
    };

    // Language change handler
    function setEditorLanguage(language) {
        var mode = 'ace/mode/python';
        switch(language) {
            case 'JAVA': mode = 'ace/mode/java'; break;
            case 'CPP':
            case 'C': mode = 'ace/mode/c_cpp'; break;
            case 'JAVASCRIPT': mode = 'ace/mode/javascript'; break;
            case 'CSHARP': mode = 'ace/mode/csharp'; break;
            case 'PHP': mode = 'ace/mode/php'; break;
            case 'RUBY': mode = 'ace/mode/ruby'; break;
            case 'PYTHON':
            default: mode = 'ace/mode/python';
        }
        editor.session.setMode(mode);
    }

    // Load boilerplate code for a language
    function loadBoilerplate(language) {
        const code = boilerplateCode[language] || boilerplateCode['PYTHON'];
        editor.setValue(code, -1);
    }

    // Language selector change
    document.getElementById('language').addEventListener('change', function() {
        const language = this.value;
        setEditorLanguage(language);
        loadBoilerplate(language);
    });

    // Initialize with Python boilerplate
    loadBoilerplate('PYTHON');

    // Custom input checkbox
    document.getElementById('custom-input-checkbox').addEventListener('change', function() {
        const container = document.querySelector('.custom-input-container');
        if (this.checked) {
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
        }
    });

    // Compile Code
    document.getElementById('compile-code').addEventListener('click', function() {
        var sourceCode = editor.getValue();
        var language = document.getElementById('language').value;
        
        if (!sourceCode.trim()) {
            showResult('Please write some code before compiling!', 'error');
            return;
        }
        
        this.disabled = true;
        this.innerHTML = '⏳ Compiling...';
        
        // Use existing compile endpoint
        fetch('/compile/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `source=${encodeURIComponent(sourceCode)}&lang=${language}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.he_id && data.request_status && data.request_status.code === 'REQUEST_QUEUED') {
                // HackerEarth API V4 is asynchronous - poll for results
                showResult('⏳ Code submitted for compilation, checking status...', 'info');
                pollCompileStatus(data.he_id);
            } else {
                updateOutputDetails(data);
                if (data.compile_status === 'OK' || data.fallback) {
                    showResult('✅ Code compiled successfully!' + (data.fallback ? ' (Development Mode)' : ''), 'success');
                } else {
                    showResult('❌ Compilation failed: ' + data.message, 'error');
                }
            }
        })
        .catch(error => {
            showResult('Error compiling code: ' + error.message, 'error');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '🔨 Compile Code';
        });
    });

    // Run Code
    document.getElementById('run-code').addEventListener('click', function() {
        var sourceCode = editor.getValue();
        var language = document.getElementById('language').value;
        var customInput = document.getElementById('custom-input').value;
        var useCustomInput = document.getElementById('custom-input-checkbox').checked;
        
        if (!sourceCode.trim()) {
            showResult('Please write some code before running!', 'error');
            return;
        }
        
        this.disabled = true;
        this.innerHTML = '⏳ Running...';
        
        // Use existing run endpoint
        fetch('/run/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `source=${encodeURIComponent(sourceCode)}&lang=${language}&input=${encodeURIComponent(useCustomInput ? customInput : '')}&time_limit=5&memory_limit=262144`
        })
        .then(response => response.json())
        .then(data => {
            if (data.he_id && data.request_status && data.request_status.code === 'REQUEST_QUEUED') {
                // HackerEarth API V4 is asynchronous - poll for results
                showResult('⏳ Code submitted for execution, checking status...', 'info');
                pollRunStatus(data.he_id);
            } else {
                updateOutputDetails(data);
                if (data.run_status && data.run_status.status === 'AC') {
                    showResult('✅ Code executed successfully!' + (data.fallback ? ' (Development Mode)' : ''), 'success');
                } else if (data.compile_status === 'OK' || data.fallback) {
                    if (data.fallback) {
                        showResult('✅ Code executed successfully! (Development Mode)', 'success');
                    } else {
                        showResult('⚠️ Code compiled but execution failed: ' + (data.run_status ? data.run_status.status : 'Unknown error'), 'warning');
                    }
                } else {
                    showResult('❌ Compilation failed: ' + data.message, 'error');
                }
            }
        })
        .catch(error => {
            showResult('Error running code: ' + error.message, 'error');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '🚀 Run Code';
        });
    });

    function updateOutputDetails(data) {
        const outputBox = document.querySelector('.output-response-box');
        outputBox.style.display = 'block';
        
        // Update status details
        document.querySelector('.compile-status .value').textContent = data.compile_status || 'Unknown';
        document.querySelector('.run-status .value').textContent = data.run_status ? data.run_status.status : 'Unknown';
        document.querySelector('.time-sec .value').textContent = data.run_status ? data.run_status.time_used : '0.0';
        document.querySelector('.memory-kb .value').textContent = data.run_status ? data.run_status.memory_used : '0';
        
        // Update input/output
        const inputText = document.querySelector('.output-i');
        const outputText = document.querySelector('.output-o');
        const errorMessage = document.querySelector('.error-message');
        
        if (data.run_status) {
            inputText.textContent = data.run_status.input || 'No input';
            outputText.textContent = data.run_status.output_html || 'No output';
            errorMessage.textContent = data.run_status.stderr || '';
        } else if (data.fallback) {
            // Handle fallback mode - show simulated output
            inputText.textContent = 'No input';
            outputText.textContent = 'Hello, World!';
            errorMessage.textContent = '';
        }
        
        // Show/hide sections based on content
        const inputInfo = document.querySelector('.output-i-info');
        const outputInfo = document.querySelector('.output-o-info');
        const errorBox = document.querySelector('.output-error-box');
        
        inputInfo.style.display = 'block';
        outputInfo.style.display = 'block';
        errorBox.style.display = data.run_status && data.run_status.stderr ? 'block' : 'none';
    }

    function showResult(message, type) {
        // Create a temporary alert
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'info' ? 'info' : 'warning'} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert at the top of the editor container
        const editorContainer = document.querySelector('.editor-container');
        editorContainer.insertBefore(alertDiv, editorContainer.firstChild);
        
        // Auto-hide after 3 seconds for info messages, 5 seconds for others
        const hideDelay = type === 'info' ? 3000 : 5000;
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, hideDelay);
    }

    function pollCompileStatus(he_id) {
        const maxAttempts = 10;
        let attempts = 0;
        
        const poll = () => {
            attempts++;
            fetch(`/status/${he_id}/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.compile_status === 'OK' || data.compile_status === 'CE') {
                    // Compilation complete
                    updateOutputDetails(data);
                    if (data.compile_status === 'OK') {
                        showResult('✅ Code compiled successfully!', 'success');
                    } else {
                        showResult('❌ Compilation failed', 'error');
                    }
                } else if (attempts < maxAttempts) {
                    // Still processing, wait and try again
                    setTimeout(poll, 2000);
                } else {
                    // Timeout
                    showResult('⏰ Compilation timeout - please try again', 'warning');
                }
            })
            .catch(error => {
                showResult('Error checking compilation status: ' + error.message, 'error');
            });
        };
        
        poll();
    }

    function pollRunStatus(he_id) {
        const maxAttempts = 15;
        let attempts = 0;
        
        const poll = () => {
            attempts++;
            fetch(`/status/${he_id}/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                const runStatus = data.run_status ? data.run_status.status : 'Unknown';
                
                if (runStatus === 'AC' || runStatus === 'RE' || runStatus === 'TLE' || runStatus === 'MLE') {
                    // Execution complete
                    updateOutputDetails(data);
                    if (runStatus === 'AC') {
                        showResult('✅ Code executed successfully!', 'success');
                    } else {
                        showResult('❌ Execution failed: ' + runStatus, 'error');
                    }
                } else if (attempts < maxAttempts) {
                    // Still processing, wait and try again
                    setTimeout(poll, 2000);
                } else {
                    // Timeout
                    showResult('⏰ Execution timeout - please try again', 'warning');
                }
            })
            .catch(error => {
                showResult('Error checking execution status: ' + error.message, 'error');
            });
        };
        
        poll();
    }

    // Initialize with Python
    setEditorLanguage('PYTHON');
    </script>
{% endblock %}